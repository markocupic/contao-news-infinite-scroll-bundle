"use strict";/*
 * This file is part of Contao News Infinite Scroll Bundle.
 *
 * (c) Marko Cupic 2024 <m.cupic@gmx.ch>
 * @license LGPL-3.0+
 * For the full copyright and license information,
 * please view the LICENSE file that was distributed with this source code.
 * @link https://github.com/markocupic/contao-news-infinite-scroll-bundle
 */ const ContaoInfiniteScroll={};ContaoInfiniteScroll.Modes={LOAD_MORE_BUTTON:"load_more_button",AUTOLOAD_ON_DOMREADY:"autoload_on_domready",INFINITE_SCROLL:"infinite_scroll"},ContaoInfiniteScroll.Defaults={loadingMode:ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON,scrollContainer:null,pagination:{selectorNext:".pagination > .next > a.next[href]",selectorLast:".pagination > .last > a.last[href]",paramPageRegex:"page([_a-z]*)(d*)"},loadMoreButtonMarkup:'<div class="inf-scr-load-more-btn-container" role="button" tabindex="0"><span class="inf-scr-load-more-btn-inner">load more content</span></div>',loadingInProcessIndicatorMarkup:'<div class="inf-scr-loading-in-process-container"><span class="inf-scr-loading-in-process-inner">loading...</span></div>'},ContaoInfiniteScroll.Utils={getUrlsFromPagination:function(t,n=null,i){let e=[],o=t.getAttribute("href");if(null===(o=(o=o?o.replace(RegExp("^\\/"),""):null)?window.location.origin+"/"+o:null))return console.warn("Infinite scroll initialization aborted! Could not find a valid pagination link."),e;let r=new URL(o),s=r.searchParams,a=null;for(let l of s.keys())if(RegExp(i,"g").exec(l)){a=l;break}if(null===a)return console.error('Infinite scroll initialization aborted! Could not find pagination link with pattern "'+i+'".'),e;let c=parseInt(s.get(a)),h=c;if(n){let d=n.getAttribute("href")?window.location.origin+"/"+n.getAttribute("href"):null;if(null!==d){let f=new URL(d),u=f.searchParams;u.has(a)&&(h=parseInt(u.get(a)))}}for(let p=c;p<=h;p++)s.set(a,p.toString()),e.push(r.origin+r.pathname+"?"+s.toString());return e}};class ContaoInfiniteScrollApp{constructor(t,n){this.#a(t,n)}arrUrls=[];blnHasError=!1;blnErrorMessage="";urlIndex=0;#b=null;#c={};#d=null;#e=null;#f=null;#g=!1;#h=!1;#i=!1;#j=null;#k={"contao.infinite_scroll.initialize":[],"contao.infinite_scroll.xhr_start":[],"contao.infinite_scroll.xhr_complete":[],"contao.infinite_scroll.xhr_error":[],"contao.infinite_scroll.append":[],"contao.infinite_scroll.appended":[]};execute=function(){if(this.#l("contao.infinite_scroll.initialize")&&!1===this.#m("contao.infinite_scroll.initialize",[this])){this.#g=!0;return}if(0!==this.arrUrls.length){if(this.#b===ContaoInfiniteScroll.Modes.AUTOLOAD_ON_DOMREADY)this.load(),this.#j=setInterval(()=>{this.load()},3e3);else if(this.#b===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON)this.#n();else if(this.#b===ContaoInfiniteScroll.Modes.INFINITE_SCROLL){let t={root:this.#e,rootMargin:"0px",threshold:1},n=new IntersectionObserver(t=>{for(let n of t)n.isIntersecting&&this.load()},t);n.observe(this.#f)}else throw Error(this.#b+' is not a valid loading mode. Please choose one of these: "'+Object.values(ContaoInfiniteScroll.Modes).join('", ')+'".')}};on=function(t,n){if(!this.#k.hasOwnProperty(t))throw Error(t+' is not a valid event name. Please choose one of these: "'+Object.keys(this.#k).join('", ')+'".');return this.#k[t].push(n),this};getOption=function(t){return void 0!==this.#c[t]&&this.#c[t]};getContainer=function(){return this.#d};load=async function(){this.blnHasError=!1;let t="";if(!0===this.#h||!0===this.#i)return;let n=this.arrUrls[this.urlIndex];if(void 0!==n){n+="&ajaxCall=true",this.#d.setAttribute("aria-busy","true"),this.#h=!0,this.#o(),this.#p(),this.#l("contao.infinite_scroll.xhr_start")&&this.#m("contao.infinite_scroll.xhr_start",[this,n]);try{let i=await fetch(n,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest"}});if(!i.ok)throw`An error has occurred: ${i.status}`;let e=await i.json();if("string"!=typeof e.status||"success"!==e.status)throw`Something went wrong. Status: ${e.status}.`;t=e.data}catch(o){throw this.#d.setAttribute("aria-busy","false"),this.#q(),this.#b===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON&&this.#n(),this.#h=!1,this.#r(o),Error(o)}this.#l("contao.infinite_scroll.xhr_complete")&&(t=this.#m("contao.infinite_scroll.xhr_complete",[this,t])),!1===this.blnHasError&&(this.urlIndex++,await new Promise(n=>{setTimeout(()=>{this.#s(t),n()},1e3)})),this.#d.setAttribute("aria-busy","false"),this.#q(),this.arrUrls.length===this.urlIndex?(this.#i=!0,this.#o(),void 0!==this.#j&&clearInterval(this.#j)):this.#b===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON&&this.#n(),this.#h=!1}};#a=function(t,n){if(this.#d=t,this.#c={...ContaoInfiniteScroll.Defaults,...n??{}},this.#b=this.#c.loadingMode,!Object.values(ContaoInfiniteScroll.Modes).includes(this.#b))throw Error(this.#b+' is not a valid loading mode. Please choose one of these: "'+Object.values(ContaoInfiniteScroll.Modes).join('", ')+'".');return this.arrUrls=ContaoInfiniteScroll.Utils.getUrlsFromPagination(this.#d.querySelector(this.#c.pagination.selectorNext),this.#d.querySelector(this.#c.pagination.selectorLast),this.#c.pagination.paramPageRegex),this.#f=this.#d.parentElement.querySelector(".infinite_scroll_anchor"),this};#m=function(t,n=[]){let i;for(let e=0;e<this.#k[t].length;e++)i=this.#k[t][e](...n);return i};#l=function(t){return this.#k[t].length>0};#r=function(t=""){this.blnHasError=!0,this.#h=!1,this.#l("contao.infinite_scroll.xhr_error")&&this.#m("contao.infinite_scroll.xhr_error",[this,t])};#s=function(t){let n=document.createElement("template");n.innerHTML=t;let i=n.content;this.#l("contao.infinite_scroll.append")&&(i=this.#m("contao.infinite_scroll.append",[this,i])),this.#d.append(i),this.#l("contao.infinite_scroll.appended")&&this.#m("contao.infinite_scroll.appended",[this])};#n=function(){let t=this.#d.querySelector(".inf-scr-load-more-btn-container");if(!t){let n=document.createElement("template");for(let i of(n.innerHTML=this.#c.loadMoreButtonMarkup,t=n.content.firstElementChild,this.#d.after(t),t.classList.add("inf-scr-load-more-btn-container"),t.setAttribute("data-display",""!==t.style.display?t.style.display:"block"),["click","keydown"]))t.addEventListener(i,n=>{if("keydown"===n.type&&13!==n.keyCode){n.stopPropagation();return}t.style.display="none",this.load()},{once:!0})}};#o=function(){let t=this.#d.parentNode.querySelector(".inf-scr-load-more-btn-container");t&&t.remove()};#p=function(){let t=this.#d.querySelector(".inf-scr-loading-in-process-indicator");if(!t&&""!==this.#c.loadingInProcessIndicatorMarkup){let n=document.createElement("template");n.innerHTML=this.#c.loadingInProcessIndicatorMarkup,t=n.content.firstElementChild,this.#d.after(t),t.classList.add("inf-scr-loading-in-process-indicator")}};#q=function(){let t=this.#d.parentElement.querySelectorAll(".inf-scr-loading-in-process-indicator");for(let n of t)n.remove()}}