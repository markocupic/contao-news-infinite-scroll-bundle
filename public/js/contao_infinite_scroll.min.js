"use strict";
/*
 * This file is part of Contao News Infinite Scroll Bundle.
 *
 * (c) Marko Cupic 2023 <m.cupic@gmx.ch>
 * @license LGPL-3.0+
 * For the full copyright and license information,
 * please view the LICENSE file that was distributed with this source code.
 * @link https://github.com/markocupic/contao-news-infinite-scroll-bundle
 */function _classPrivateFieldInitSpec(obj,privateMap,value){_checkPrivateRedeclaration(obj,privateMap),privateMap.set(obj,value)}function _checkPrivateRedeclaration(obj,privateCollection){if(privateCollection.has(obj))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _defineProperty(obj,key,value){return(key=_toPropertyKey(key))in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return"symbol"==typeof key?key:String(key)}function _toPrimitive(input,hint){if("object"!=typeof input||null===input)return input;var prim=input[Symbol.toPrimitive];if(void 0!==prim){var res=prim.call(input,hint||"default");if("object"!=typeof res)return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===hint?String:Number)(input)}function _classPrivateFieldSet(receiver,privateMap,value){return _classApplyDescriptorSet(receiver,_classExtractFieldDescriptor(receiver,privateMap,"set"),value),value}function _classApplyDescriptorSet(receiver,descriptor,value){if(descriptor.set)descriptor.set.call(receiver,value);else{if(!descriptor.writable)throw new TypeError("attempted to set read only private field");descriptor.value=value}}function _classPrivateFieldGet(receiver,privateMap){return _classApplyDescriptorGet(receiver,_classExtractFieldDescriptor(receiver,privateMap,"get"))}function _classExtractFieldDescriptor(receiver,privateMap,action){if(!privateMap.has(receiver))throw new TypeError("attempted to "+action+" private field on non-instance");return privateMap.get(receiver)}function _classApplyDescriptorGet(receiver,descriptor){return descriptor.get?descriptor.get.call(receiver):descriptor.value}const ContaoInfiniteScroll={Modes:{LOAD_MORE_BUTTON:"load_more_button",AUTOLOAD_ON_DOMREADY:"autoload_on_domready",INFINITE_SCROLL:"infinite_scroll"}};ContaoInfiniteScroll.Defaults={loadingMode:ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON,scrollContainer:null,pagination:{selectorNext:".pagination > .next > a.next[href]",selectorLast:".pagination > .last > a.last[href]",paramPageRegex:"page([_a-z]*)(d*)"},loadMoreButtonMarkup:'<div class="inf-scr-load-more-btn-container" role="button" tabindex="0"><span class="inf-scr-load-more-btn-inner">load more content</span></div>',loadingInProcessIndicatorMarkup:'<div class="inf-scr-loading-in-process-container"><span class="inf-scr-loading-in-process-inner">loading...</span></div>'},ContaoInfiniteScroll.Utils={getUrlsFromPagination:function(elNextLink,elLastLink=null,paginationUrlParamRegexPattern){let arrUrls=[];const hrefNext=elNextLink.getAttribute("href")?window.location.origin+"/"+elNextLink.getAttribute("href"):null;if(null===hrefNext)return console.warn("Infinite scroll initialization aborted! Could not find a valid pagination link."),arrUrls;const urlNext=new URL(hrefNext),urlParamsNext=urlNext.searchParams;let paramPage=null;for(const key of urlParamsNext.keys()){if(new RegExp(paginationUrlParamRegexPattern,"g").exec(key)){paramPage=key;break}}if(null===paramPage)return console.error('Infinite scroll initialization aborted! Could not find pagination link with pattern "'+paginationUrlParamRegexPattern+'".'),arrUrls;const pageIdNext=parseInt(urlParamsNext.get(paramPage));let pageIdLast=pageIdNext;if(elLastLink){const hrefLast=elLastLink.getAttribute("href")?window.location.origin+"/"+elLastLink.getAttribute("href"):null;if(null!==hrefLast){const urlParamsLast=new URL(hrefLast).searchParams;urlParamsLast.has(paramPage)&&(pageIdLast=parseInt(urlParamsLast.get(paramPage)))}}for(let i=pageIdNext;i<=pageIdLast;i++)urlParamsNext.set(paramPage,i.toString()),arrUrls.push(urlNext.origin+urlNext.pathname+"?"+urlParamsNext.toString());return arrUrls}};var _loadingMode=new WeakMap,_opts=new WeakMap,_container=new WeakMap,_scrollContainer=new WeakMap,_anchorPoint=new WeakMap,_executionStoppedAfterInitialization=new WeakMap,_blnLoadingInProcess=new WeakMap,_blnAllItemsLoaded=new WeakMap,_xhrInterval=new WeakMap,_listeners=new WeakMap,_initialize=new WeakMap,_dispatchEvent=new WeakMap,_hasListener=new WeakMap,_handleAjaxError=new WeakMap,_appendItemsToContainer=new WeakMap,_appendLoadMoreButtonAfterContainer=new WeakMap,_removeLoadMoreButton=new WeakMap,_appendLoadingIndicatorAfterContainer=new WeakMap,_removeLoadingIndicator=new WeakMap;class ContaoInfiniteScrollApp{constructor(_listItemsContainer,_options){_defineProperty(this,"arrUrls",[]),_defineProperty(this,"blnHasError",!1),_defineProperty(this,"blnErrorMessage",""),_defineProperty(this,"urlIndex",0),_classPrivateFieldInitSpec(this,_loadingMode,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_opts,{writable:!0,value:{}}),_classPrivateFieldInitSpec(this,_container,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_scrollContainer,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_anchorPoint,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_executionStoppedAfterInitialization,{writable:!0,value:!1}),_classPrivateFieldInitSpec(this,_blnLoadingInProcess,{writable:!0,value:!1}),_classPrivateFieldInitSpec(this,_blnAllItemsLoaded,{writable:!0,value:!1}),_classPrivateFieldInitSpec(this,_xhrInterval,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_listeners,{writable:!0,value:{"contao.infinite_scroll.initialize":[],"contao.infinite_scroll.xhr_start":[],"contao.infinite_scroll.xhr_complete":[],"contao.infinite_scroll.xhr_error":[],"contao.infinite_scroll.append":[],"contao.infinite_scroll.appended":[]}}),_defineProperty(this,"execute",(function(){if(_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.initialize")&&!1===_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.initialize",[this]))_classPrivateFieldSet(this,_executionStoppedAfterInitialization,!0);else if(0!==this.arrUrls.length)if(_classPrivateFieldGet(this,_loadingMode)===ContaoInfiniteScroll.Modes.AUTOLOAD_ON_DOMREADY)this.load(),_classPrivateFieldSet(this,_xhrInterval,setInterval((()=>{this.load()}),3e3));else if(_classPrivateFieldGet(this,_loadingMode)===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON)_classPrivateFieldGet(this,_appendLoadMoreButtonAfterContainer).call(this);else{if(_classPrivateFieldGet(this,_loadingMode)!==ContaoInfiniteScroll.Modes.INFINITE_SCROLL)throw new Error(_classPrivateFieldGet(this,_loadingMode)+' is not a valid loading mode. Please choose one of these: "'+Object.values(ContaoInfiniteScroll.Modes).join('", ')+'".');{const options={root:_classPrivateFieldGet(this,_scrollContainer),rootMargin:"0px",threshold:1};new IntersectionObserver((entries=>{for(const entry of entries)entry.isIntersecting&&this.load()}),options).observe(_classPrivateFieldGet(this,_anchorPoint))}}})),_defineProperty(this,"on",(function(eventName,callback){if(!_classPrivateFieldGet(this,_listeners).hasOwnProperty(eventName))throw new Error(eventName+' is not a valid event name. Please choose one of these: "'+Object.keys(_classPrivateFieldGet(this,_listeners)).join('", ')+'".');return _classPrivateFieldGet(this,_listeners)[eventName].push(callback),this})),_defineProperty(this,"getOption",(function(option){return void 0!==_classPrivateFieldGet(this,_opts)[option]&&_classPrivateFieldGet(this,_opts)[option]})),_defineProperty(this,"getContainer",(function(){return _classPrivateFieldGet(this,_container)})),_defineProperty(this,"load",(function(){if(!0===_classPrivateFieldGet(this,_blnLoadingInProcess)||!0===_classPrivateFieldGet(this,_blnAllItemsLoaded))return;this.blnHasError=!1;let currentUrl=this.arrUrls[this.urlIndex];void 0!==currentUrl?(currentUrl+="&ajaxCall=true",_classPrivateFieldGet(this,_container).setAttribute("aria-busy","true"),_classPrivateFieldSet(this,_blnLoadingInProcess,!0),_classPrivateFieldGet(this,_removeLoadMoreButton).call(this),_classPrivateFieldGet(this,_appendLoadingIndicatorAfterContainer).call(this),_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.xhr_start")&&_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.xhr_start",[this,currentUrl]),fetch(currentUrl,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest"}}).then((response=>response.ok?response.json():Promise.reject(response))).then((json=>"undefined"===json.data?Promise.reject(json):json.data)).then((responseText=>(this.blnHasError=!1,"string"!=typeof responseText?Promise.reject("Response data is not of type string."):(_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.xhr_complete")&&(responseText=_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.xhr_complete",[this,responseText])),!1!==this.blnHasError?Promise.reject(response):(this.urlIndex++,void setTimeout((()=>{_classPrivateFieldGet(this,_appendItemsToContainer).call(this,responseText)}),1e3)))))).catch((function(error){console.warn(error),_classPrivateFieldGet(this,_handleAjaxError).call(this,error)})).finally((()=>{setTimeout((()=>{_classPrivateFieldGet(this,_container).setAttribute("aria-busy","false"),_classPrivateFieldGet(this,_removeLoadingIndicator).call(this),this.arrUrls.length===this.urlIndex?(_classPrivateFieldSet(this,_blnAllItemsLoaded,!0),_classPrivateFieldGet(this,_removeLoadMoreButton).call(this),void 0!==_classPrivateFieldGet(this,_xhrInterval)&&clearInterval(_classPrivateFieldGet(this,_xhrInterval))):_classPrivateFieldGet(this,_loadingMode)===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON&&_classPrivateFieldGet(this,_appendLoadMoreButtonAfterContainer).call(this),_classPrivateFieldSet(this,_blnLoadingInProcess,!1)}),1e3)}))):(_classPrivateFieldSet(this,_blnAllItemsLoaded,!0),void 0!==_classPrivateFieldGet(this,_xhrInterval)&&clearInterval(_classPrivateFieldGet(this,_xhrInterval)))})),_classPrivateFieldInitSpec(this,_initialize,{writable:!0,value:function(listItemsContainer,options){if(_classPrivateFieldSet(this,_container,listItemsContainer),_classPrivateFieldSet(this,_opts,{...ContaoInfiniteScroll.Defaults,...null!=options?options:{}}),_classPrivateFieldSet(this,_loadingMode,_classPrivateFieldGet(this,_opts).loadingMode),!Object.values(ContaoInfiniteScroll.Modes).includes(_classPrivateFieldGet(this,_loadingMode)))throw new Error(_classPrivateFieldGet(this,_loadingMode)+' is not a valid loading mode. Please choose one of these: "'+Object.values(ContaoInfiniteScroll.Modes).join('", ')+'".');return this.arrUrls=ContaoInfiniteScroll.Utils.getUrlsFromPagination(_classPrivateFieldGet(this,_container).querySelector(_classPrivateFieldGet(this,_opts).pagination.selectorNext),_classPrivateFieldGet(this,_container).querySelector(_classPrivateFieldGet(this,_opts).pagination.selectorLast),_classPrivateFieldGet(this,_opts).pagination.paramPageRegex),_classPrivateFieldSet(this,_anchorPoint,_classPrivateFieldGet(this,_container).parentElement.querySelector(".infinite_scroll_anchor")),this}}),_classPrivateFieldInitSpec(this,_dispatchEvent,{writable:!0,value:function(strEventName,args=[]){let returnValue;for(let index=0;index<_classPrivateFieldGet(this,_listeners)[strEventName].length;index++)returnValue=_classPrivateFieldGet(this,_listeners)[strEventName][index](...args);return returnValue}}),_classPrivateFieldInitSpec(this,_hasListener,{writable:!0,value:function(strEventName){return _classPrivateFieldGet(this,_listeners)[strEventName].length>0}}),_classPrivateFieldInitSpec(this,_handleAjaxError,{writable:!0,value:function(errorMsg=""){this.blnHasError=!0,_classPrivateFieldSet(this,_blnLoadingInProcess,!1),_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.xhr_error")&&_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.xhr_error",[this,errorMsg])}}),_classPrivateFieldInitSpec(this,_appendItemsToContainer,{writable:!0,value:function(responseText){const template=document.createElement("template");template.innerHTML=responseText;let documentFragment=template.content;_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.append")&&(documentFragment=_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.append",[this,documentFragment])),_classPrivateFieldGet(this,_container).append(documentFragment),_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.appended")&&_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.appended",[this])}}),_classPrivateFieldInitSpec(this,_appendLoadMoreButtonAfterContainer,{writable:!0,value:function(){let loadMoreBtn=_classPrivateFieldGet(this,_container).querySelector(".inf-scr-load-more-btn-container");if(!loadMoreBtn){const loadMoreBtnTemplate=document.createElement("template");loadMoreBtnTemplate.innerHTML=_classPrivateFieldGet(this,_opts).loadMoreButtonMarkup,loadMoreBtn=loadMoreBtnTemplate.content.firstElementChild,_classPrivateFieldGet(this,_container).after(loadMoreBtn),loadMoreBtn.classList.add("inf-scr-load-more-btn-container"),loadMoreBtn.setAttribute("data-display",""!==loadMoreBtn.style.display?loadMoreBtn.style.display:"block");const events=["click","keydown"];for(const event of events)loadMoreBtn.addEventListener(event,(e=>{"keydown"!==e.type||13===e.keyCode?(loadMoreBtn.style.display="none",this.load()):e.stopPropagation()}),{once:!0})}}}),_classPrivateFieldInitSpec(this,_removeLoadMoreButton,{writable:!0,value:function(){const button=_classPrivateFieldGet(this,_container).parentNode.querySelector(".inf-scr-load-more-btn-container");button&&button.remove()}}),_classPrivateFieldInitSpec(this,_appendLoadingIndicatorAfterContainer,{writable:!0,value:function(){let elLoadingIndicator=_classPrivateFieldGet(this,_container).querySelector(".inf-scr-loading-in-process-indicator");if(!elLoadingIndicator&&""!==_classPrivateFieldGet(this,_opts).loadingInProcessIndicatorMarkup){const indicatorTemplate=document.createElement("template");indicatorTemplate.innerHTML=_classPrivateFieldGet(this,_opts).loadingInProcessIndicatorMarkup,elLoadingIndicator=indicatorTemplate.content.firstElementChild,_classPrivateFieldGet(this,_container).after(elLoadingIndicator),elLoadingIndicator.classList.add("inf-scr-loading-in-process-indicator")}}}),_classPrivateFieldInitSpec(this,_removeLoadingIndicator,{writable:!0,value:function(){const indicators=_classPrivateFieldGet(this,_container).parentElement.querySelectorAll(".inf-scr-loading-in-process-indicator");for(const indicator of indicators)indicator.remove()}}),_classPrivateFieldGet(this,_initialize).call(this,_listItemsContainer,_options)}}