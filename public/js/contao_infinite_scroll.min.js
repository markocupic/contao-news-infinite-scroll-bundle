"use strict";
/*
 * This file is part of Contao News Infinite Scroll Bundle.
 *
 * (c) Marko Cupic 2023 <m.cupic@gmx.ch>
 * @license LGPL-3.0+
 * For the full copyright and license information,
 * please view the LICENSE file that was distributed with this source code.
 * @link https://github.com/markocupic/contao-news-infinite-scroll-bundle
 */function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t),t.set(e,i)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var a=i.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _classPrivateFieldSet(e,t,i){return _classApplyDescriptorSet(e,_classExtractFieldDescriptor(e,t,"set"),i),i}function _classApplyDescriptorSet(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=i}}function _classPrivateFieldGet(e,t){return _classApplyDescriptorGet(e,_classExtractFieldDescriptor(e,t,"get"))}function _classExtractFieldDescriptor(e,t,i){if(!t.has(e))throw new TypeError("attempted to "+i+" private field on non-instance");return t.get(e)}function _classApplyDescriptorGet(e,t){return t.get?t.get.call(e):t.value}const ContaoInfiniteScroll={Modes:{LOAD_MORE_BUTTON:"load_more_button",AUTOLOAD_ON_DOMREADY:"autoload_on_domready",INFINITE_SCROLL:"infinite_scroll"}};ContaoInfiniteScroll.Defaults={loadingMode:ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON,scrollContainer:null,pagination:{selectorNext:".pagination > .next > a.next[href]",selectorLast:".pagination > .last > a.last[href]",paramPageRegex:"page([_a-z]*)(d*)"},loadMoreButtonMarkup:'<div class="inf-scr-load-more-btn-container" role="button" tabindex="0"><span class="inf-scr-load-more-btn-inner">load more content</span></div>',loadingInProcessIndicatorMarkup:'<div class="inf-scr-loading-in-process-container"><span class="inf-scr-loading-in-process-inner">loading...</span></div>'},ContaoInfiniteScroll.Utils={getUrlsFromPagination:function(e,t=null,i){let a=[];const n=e.getAttribute("href")?window.location.origin+"/"+e.getAttribute("href"):null;if(null===n)return console.warn("Infinite scroll initialization aborted! Could not find a valid pagination link."),a;const s=new URL(n),r=s.searchParams;let l=null;for(const e of r.keys()){if(new RegExp(i,"g").exec(e)){l=e;break}}if(null===l)return console.error('Infinite scroll initialization aborted! Could not find pagination link with pattern "'+i+'".'),a;const o=parseInt(r.get(l));let c=o;if(t){const e=t.getAttribute("href")?window.location.origin+"/"+t.getAttribute("href"):null;if(null!==e){const t=new URL(e).searchParams;t.has(l)&&(c=parseInt(t.get(l)))}}for(let e=o;e<=c;e++)r.set(l,e.toString()),a.push(s.origin+s.pathname+"?"+r.toString());return a}};var _loadingMode=new WeakMap,_opts=new WeakMap,_container=new WeakMap,_scrollContainer=new WeakMap,_anchorPoint=new WeakMap,_executionStoppedAfterInitialization=new WeakMap,_blnLoadingInProcess=new WeakMap,_blnAllItemsLoaded=new WeakMap,_xhrInterval=new WeakMap,_listeners=new WeakMap,_initialize=new WeakMap,_dispatchEvent=new WeakMap,_hasListener=new WeakMap,_handleAjaxError=new WeakMap,_appendItemsToContainer=new WeakMap,_appendLoadMoreButtonAfterContainer=new WeakMap,_removeLoadMoreButton=new WeakMap,_appendLoadingIndicatorAfterContainer=new WeakMap,_removeLoadingIndicator=new WeakMap;class ContaoInfiniteScrollApp{constructor(e,t){_defineProperty(this,"arrUrls",[]),_defineProperty(this,"blnHasError",!1),_defineProperty(this,"blnErrorMessage",""),_defineProperty(this,"urlIndex",0),_classPrivateFieldInitSpec(this,_loadingMode,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_opts,{writable:!0,value:{}}),_classPrivateFieldInitSpec(this,_container,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_scrollContainer,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_anchorPoint,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_executionStoppedAfterInitialization,{writable:!0,value:!1}),_classPrivateFieldInitSpec(this,_blnLoadingInProcess,{writable:!0,value:!1}),_classPrivateFieldInitSpec(this,_blnAllItemsLoaded,{writable:!0,value:!1}),_classPrivateFieldInitSpec(this,_xhrInterval,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_listeners,{writable:!0,value:{"contao.infinite_scroll.initialize":[],"contao.infinite_scroll.xhr_start":[],"contao.infinite_scroll.xhr_complete":[],"contao.infinite_scroll.xhr_error":[],"contao.infinite_scroll.append":[],"contao.infinite_scroll.appended":[]}}),_defineProperty(this,"execute",(function(){if(_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.initialize")&&!1===_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.initialize",[this]))_classPrivateFieldSet(this,_executionStoppedAfterInitialization,!0);else if(0!==this.arrUrls.length)if(_classPrivateFieldGet(this,_loadingMode)===ContaoInfiniteScroll.Modes.AUTOLOAD_ON_DOMREADY)this.load(),_classPrivateFieldSet(this,_xhrInterval,setInterval((()=>{this.load()}),3e3));else if(_classPrivateFieldGet(this,_loadingMode)===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON)_classPrivateFieldGet(this,_appendLoadMoreButtonAfterContainer).call(this);else{if(_classPrivateFieldGet(this,_loadingMode)!==ContaoInfiniteScroll.Modes.INFINITE_SCROLL)throw new Error(_classPrivateFieldGet(this,_loadingMode)+' is not a valid loading mode. Please choose one of these: "'+Object.values(ContaoInfiniteScroll.Modes).join('", ')+'".');{const e={root:_classPrivateFieldGet(this,_scrollContainer),rootMargin:"0px",threshold:1};new IntersectionObserver((e=>{for(const t of e)t.isIntersecting&&this.load()}),e).observe(_classPrivateFieldGet(this,_anchorPoint))}}})),_defineProperty(this,"on",(function(e,t){if(!_classPrivateFieldGet(this,_listeners).hasOwnProperty(e))throw new Error(e+' is not a valid event name. Please choose one of these: "'+Object.keys(_classPrivateFieldGet(this,_listeners)).join('", ')+'".');return _classPrivateFieldGet(this,_listeners)[e].push(t),this})),_defineProperty(this,"getOption",(function(e){return void 0!==_classPrivateFieldGet(this,_opts)[e]&&_classPrivateFieldGet(this,_opts)[e]})),_defineProperty(this,"getContainer",(function(){return _classPrivateFieldGet(this,_container)})),_defineProperty(this,"load",(async function(){this.blnHasError=!1;let e="";if(!0===_classPrivateFieldGet(this,_blnLoadingInProcess)||!0===_classPrivateFieldGet(this,_blnAllItemsLoaded))return;let t=this.arrUrls[this.urlIndex];if(void 0!==t){t+="&ajaxCall=true",_classPrivateFieldGet(this,_container).setAttribute("aria-busy","true"),_classPrivateFieldSet(this,_blnLoadingInProcess,!0),_classPrivateFieldGet(this,_removeLoadMoreButton).call(this),_classPrivateFieldGet(this,_appendLoadingIndicatorAfterContainer).call(this),_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.xhr_start")&&_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.xhr_start",[this,t]);try{const i=await fetch(t,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest"}});if(!i.ok)throw`An error has occurred: ${i.status}`;const a=await i.json();if("string"!=typeof a.status||"success"!==a.status)throw`Something went wrong. Status: ${a.status}.`;e=a.data}catch(e){throw _classPrivateFieldGet(this,_container).setAttribute("aria-busy","false"),_classPrivateFieldGet(this,_removeLoadingIndicator).call(this),_classPrivateFieldGet(this,_loadingMode)===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON&&_classPrivateFieldGet(this,_appendLoadMoreButtonAfterContainer).call(this),_classPrivateFieldSet(this,_blnLoadingInProcess,!1),_classPrivateFieldGet(this,_handleAjaxError).call(this,e),new Error(e)}_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.xhr_complete")&&(e=_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.xhr_complete",[this,e])),!1===this.blnHasError&&(this.urlIndex++,await new Promise((t=>{setTimeout((()=>{_classPrivateFieldGet(this,_appendItemsToContainer).call(this,e),t()}),1e3)}))),_classPrivateFieldGet(this,_container).setAttribute("aria-busy","false"),_classPrivateFieldGet(this,_removeLoadingIndicator).call(this),this.arrUrls.length===this.urlIndex?(_classPrivateFieldSet(this,_blnAllItemsLoaded,!0),_classPrivateFieldGet(this,_removeLoadMoreButton).call(this),void 0!==_classPrivateFieldGet(this,_xhrInterval)&&clearInterval(_classPrivateFieldGet(this,_xhrInterval))):_classPrivateFieldGet(this,_loadingMode)===ContaoInfiniteScroll.Modes.LOAD_MORE_BUTTON&&_classPrivateFieldGet(this,_appendLoadMoreButtonAfterContainer).call(this),_classPrivateFieldSet(this,_blnLoadingInProcess,!1)}})),_classPrivateFieldInitSpec(this,_initialize,{writable:!0,value:function(e,t){if(_classPrivateFieldSet(this,_container,e),_classPrivateFieldSet(this,_opts,{...ContaoInfiniteScroll.Defaults,...null!=t?t:{}}),_classPrivateFieldSet(this,_loadingMode,_classPrivateFieldGet(this,_opts).loadingMode),!Object.values(ContaoInfiniteScroll.Modes).includes(_classPrivateFieldGet(this,_loadingMode)))throw new Error(_classPrivateFieldGet(this,_loadingMode)+' is not a valid loading mode. Please choose one of these: "'+Object.values(ContaoInfiniteScroll.Modes).join('", ')+'".');return this.arrUrls=ContaoInfiniteScroll.Utils.getUrlsFromPagination(_classPrivateFieldGet(this,_container).querySelector(_classPrivateFieldGet(this,_opts).pagination.selectorNext),_classPrivateFieldGet(this,_container).querySelector(_classPrivateFieldGet(this,_opts).pagination.selectorLast),_classPrivateFieldGet(this,_opts).pagination.paramPageRegex),_classPrivateFieldSet(this,_anchorPoint,_classPrivateFieldGet(this,_container).parentElement.querySelector(".infinite_scroll_anchor")),this}}),_classPrivateFieldInitSpec(this,_dispatchEvent,{writable:!0,value:function(e,t=[]){let i;for(let a=0;a<_classPrivateFieldGet(this,_listeners)[e].length;a++)i=_classPrivateFieldGet(this,_listeners)[e][a](...t);return i}}),_classPrivateFieldInitSpec(this,_hasListener,{writable:!0,value:function(e){return _classPrivateFieldGet(this,_listeners)[e].length>0}}),_classPrivateFieldInitSpec(this,_handleAjaxError,{writable:!0,value:function(e=""){this.blnHasError=!0,_classPrivateFieldSet(this,_blnLoadingInProcess,!1),_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.xhr_error")&&_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.xhr_error",[this,e])}}),_classPrivateFieldInitSpec(this,_appendItemsToContainer,{writable:!0,value:function(e){const t=document.createElement("template");t.innerHTML=e;let i=t.content;_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.append")&&(i=_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.append",[this,i])),_classPrivateFieldGet(this,_container).append(i),_classPrivateFieldGet(this,_hasListener).call(this,"contao.infinite_scroll.appended")&&_classPrivateFieldGet(this,_dispatchEvent).call(this,"contao.infinite_scroll.appended",[this])}}),_classPrivateFieldInitSpec(this,_appendLoadMoreButtonAfterContainer,{writable:!0,value:function(){let e=_classPrivateFieldGet(this,_container).querySelector(".inf-scr-load-more-btn-container");if(!e){const t=document.createElement("template");t.innerHTML=_classPrivateFieldGet(this,_opts).loadMoreButtonMarkup,e=t.content.firstElementChild,_classPrivateFieldGet(this,_container).after(e),e.classList.add("inf-scr-load-more-btn-container"),e.setAttribute("data-display",""!==e.style.display?e.style.display:"block");const i=["click","keydown"];for(const t of i)e.addEventListener(t,(t=>{"keydown"!==t.type||13===t.keyCode?(e.style.display="none",this.load()):t.stopPropagation()}),{once:!0})}}}),_classPrivateFieldInitSpec(this,_removeLoadMoreButton,{writable:!0,value:function(){const e=_classPrivateFieldGet(this,_container).parentNode.querySelector(".inf-scr-load-more-btn-container");e&&e.remove()}}),_classPrivateFieldInitSpec(this,_appendLoadingIndicatorAfterContainer,{writable:!0,value:function(){let e=_classPrivateFieldGet(this,_container).querySelector(".inf-scr-loading-in-process-indicator");if(!e&&""!==_classPrivateFieldGet(this,_opts).loadingInProcessIndicatorMarkup){const t=document.createElement("template");t.innerHTML=_classPrivateFieldGet(this,_opts).loadingInProcessIndicatorMarkup,e=t.content.firstElementChild,_classPrivateFieldGet(this,_container).after(e),e.classList.add("inf-scr-loading-in-process-indicator")}}}),_classPrivateFieldInitSpec(this,_removeLoadingIndicator,{writable:!0,value:function(){const e=_classPrivateFieldGet(this,_container).parentElement.querySelectorAll(".inf-scr-loading-in-process-indicator");for(const t of e)t.remove()}}),_classPrivateFieldGet(this,_initialize).call(this,e,t)}}